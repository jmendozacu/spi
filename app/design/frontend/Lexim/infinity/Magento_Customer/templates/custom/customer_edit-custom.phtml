<?php
/**
 * Binary Anvil, Inc.
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Binary Anvil, Inc. Software Agreement
 * that is bundled with this package in the file LICENSE_BAS.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.binaryanvil.com/software/license/
 *
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@binaryanvil.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this software to
 * newer versions in the future. If you wish to customize this software for
 * your needs please refer to http://www.binaryanvil.com/software for more
 * information.
 *
 * @category    BinaryAnvil
 * @package     Infinity
 * @copyright   Copyright (c) 2018-2019 Binary Anvil,Inc. (http://www.binaryanvil.com)
 * @license     http://www.binaryanvil.com/software/license
 */

// @codingStandardsIgnoreFile

/** @var \Magento\Customer\Block\Form\Edit $block */

/** @var \BinaryAnvil\Customer\Helper\Data $dataHelper */
$dataHelper = $this->helper(\BinaryAnvil\Customer\Helper\Data::class);

$customAttributes = $block->getCustomer()->getCustomAttributes();
?>
<form class="form form-edit-account" action="<?= /* @escapeNotVerified */
$block->getUrl('customer/account/editPost') ?>" method="post" id="form-validate" enctype="multipart/form-data"
      data-hasrequired="<?= /* @escapeNotVerified */
      __('* Required Fields') ?>" autocomplete="off">
    <?= $block->getBlockHtml('formkey') ?>
    <fieldset class="fieldset name">
        <div class="field name required" data-container="change-name">
            <div class="wrap">
                <div class="col lable"><span><?= __('Name'); ?></span></div>
                <div class="col value"><?= $block->escapeHtml($block->getCustomer()->getFirstName() . ' ' . $block->getCustomer()->getLastName()) ?></div>
                <div class="col action"><a href="#"><?= __('Edit'); ?></a></div>
            </div>
            <div class="content">
                <div class="title"><span><?= __('Name'); ?></span>
                    <button class="action cancel" title="<?= /* @escapeNotVerified */
                    __('Edit') ?>">Edit
                    </button>
                </div>
                <div class="content-details">
                    <?= $block->getLayout()->createBlock('Magento\Customer\Block\Widget\Name')->setObject($block->getCustomer())->toHtml() ?>
                    <div class="primary">

                        <button type="submit" class="action save primary" title="<?= /* @escapeNotVerified */
                        __('Save') ?>"><span><?= /* @escapeNotVerified */
                                __('Save Changes') ?></span></button>
                    </div>
                </div>
            </div>
        </div>
    </fieldset>
    <fieldset class="fieldset email">
        <div class="field email required" data-container="change-email">
            <div class="wrap">
                <div class="col lable"><span><?= __('Email'); ?></span></div>
                <div class="col value"><?= $block->escapeHtml($block->getCustomer()->getEmail()) ?></div>
                <div class="col action"><a href="#"><?= __('Edit'); ?></a></div>
            </div>
            <div class="content">
                <div class="title"><span><?= __('Email'); ?></span>
                    <button class="action cancel" title="<?= /* @escapeNotVerified */
                    __('Edit') ?>">Edit
                    </button>
                </div>
                <div class="content-details">
                    <label class="label" for="email"><span><?= /* @escapeNotVerified */
                            __('Email') ?></span></label>
                    <div class="control">
                        <input type="email" autocomplete="email" name="email" id="email" data-input="change-email"
                               value="<?= $block->escapeHtml($block->getCustomer()->getEmail()) ?>"
                               title="<?= /* @escapeNotVerified */
                               __('Email') ?>" class="input-text"
                               data-validate="{required:true, 'validate-email':true}"/>
                    </div>
                    <div class="field choice">
                        <input type="checkbox" name="change_email" id="change-email" data-role="change-email" value="1"
                               title="<?= $block->escapeHtmlAttr(__('Change Email')) ?>" class="checkbox"/>
                        <label class="label"
                               for="change-email"><span><?= $block->escapeHtml(__('Change Email')) ?></span></label>
                    </div>
                    <div class="primary">
                        <button type="submit" class="action save primary" title="<?= /* @escapeNotVerified */
                        __('Save') ?>"><span><?= /* @escapeNotVerified */
                                __('Save Changes') ?></span></button>
                    </div>
                </div>
                <div></div>
            </div>
        </div>
    </fieldset>

    <?= /* @noEscape */
    $block->getChildHtml('form_fields_before_in_form') ?>
    <fieldset class="fieldset password">
        <div class="field password" data-container="change-email-password">
            <div class="wrap">
                <div class="col lable"><span><?= __('Password'); ?></span></div>
                <div class="col value"><span><?= __('**********'); ?></span></div>
                <div class="col action"><a href="#"><?= __('Edit'); ?></a></div>
            </div>
            <div class="content">
                <div class="title"><span><?= __('Password'); ?></span>
                    <button class="action cancel" title="<?= /* @escapeNotVerified */
                    __('Edit') ?>">Edit
                    </button>
                </div>
                <div class="content-details">
                    <div class="field password current required">
                        <label class="label" for="current-password"><span><?= /* @escapeNotVerified */
                                __('Current Password') ?></span></label>
                        <div class="control">
                            <input type="password" class="input-text" name="current_password" id="current-password"
                                   data-input="current-password" autocomplete="off"/>
                        </div>
                    </div>
                    <div class="field new password required" data-container="new-password">
                        <label class="label" for="password"><span><?= /* @escapeNotVerified */
                                __('New Password') ?></span></label>
                        <div class="control">
                            <input type="password" class="input-text" name="password" id="password"
                                   data-password-min-length="<?= $block->escapeHtml($block->getMinimumPasswordLength()) ?>"
                                   data-password-min-character-sets="<?= $block->escapeHtml($block->getRequiredCharacterClassesNumber()) ?>"
                                   data-input="new-password"
                                   data-validate="{required:true, 'validate-customer-password':true}"
                                   autocomplete="off"/>
                            <div id="password-strength-meter-container" data-role="password-strength-meter"
                                 aria-live="polite">
                                <div id="password-strength-meter" class="password-strength-meter">
                                    <?= /* @escapeNotVerified */
                                    __('Password Strength') ?>:
                                    <span id="password-strength-meter-label" data-role="password-strength-meter-label">
                            <?= /* @escapeNotVerified */
                            __('No Password') ?>
                        </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field confirm password required" data-container="confirm-password">
                        <label class="label" for="password-confirmation"><span><?= /* @escapeNotVerified */
                                __('Confirm New Password') ?></span></label>
                        <div class="control">
                            <input type="password" class="input-text" name="password_confirmation"
                                   id="password-confirmation"
                                   data-input="confirm-password"
                                   autocomplete="off"/>
                        </div>
                    </div>
                    <div class="field choice">
                        <input type="checkbox" name="change_password" id="change-password" data-role="change-password"
                               value="1"
                               title="<?= $block->escapeHtmlAttr(__('Change Password')) ?>"<?php if ($block->getChangePassword()): ?> checked="checked"<?php endif; ?>
                               class="checkbox"/>
                        <label class="label"
                               for="change-password"><span><?= $block->escapeHtml(__('Change Password')) ?></span></label>
                    </div>
                    <div class="primary">
                        <button type="submit" class="action save primary" title="<?= /* @escapeNotVerified */
                        __('Save') ?>"><span><?= /* @escapeNotVerified */
                                __('Save Changes') ?></span></button>
                    </div>
                </div>
                <div></div>
            </div>
            <?= $block->getChildHtml('form_additional_info') ?>
        </div>
    </fieldset>
</form>
<script>
    require([
        "jquery",
        "mage/mage"
    ], function ($) {
        var dataForm = $('#form-validate');
        var ignore = null;

        dataForm.mage('validation', {
            ignore: ignore ? ':hidden:not(' + ignore + ')' : ':hidden'
        });

    });
</script>
<script type="text/x-magento-init">
    {
        "[data-role=change-email], [data-role=change-password]": {
            "changeEmailPassword": {
                "titleChangeEmail": "<?= /* @escapeNotVerified */
    __('Change Email') ?>",
                "titleChangePassword": "<?= /* @escapeNotVerified */
    __('Change Password') ?>",
                "titleChangeEmailAndPassword": "<?= /* @escapeNotVerified */
    __('Change Email and Password') ?>"
            }
        },
        "[data-container=new-password]": {
            "passwordStrengthIndicator": {
                "formSelector": "form.form-edit-account"
            }
        }
    }

</script>

<script>
    require(['jquery'], function ($) {
        $(function () {
            $('.wrap a').click(function (e) {
                e.preventDefault();
                var wrapParent = $(this).parent().parent().parent();

                if (wrapParent.hasClass('password')) {
                    $("#change-password").click();
                }
                if (wrapParent.hasClass('email')) {
                    $("#change-email").click();
                }
                wrapParent.find('.wrap').toggle().toggleClass('active');
                wrapParent.find('.content').toggle().toggleClass('active');
            });

            $('.content .cancel').click(function (e) {
                e.preventDefault();
                var wrapParent = $(this).parent().parent().parent().parent();

                if (wrapParent.hasClass('password')) {
                    $("#change-password").click();
                }
                if (wrapParent.hasClass('email')) {
                    $("#change-email").click();
                }
                wrapParent.find('.wrap').toggle().toggleClass('active');
                wrapParent.find('.content').toggle().toggleClass('active');
            });
        });
    });
</script>
<?php
$_objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$savedAddres = $_objectManager->get('BinaryAnvil\Customer\Block\AccountData');
$getAddres = $savedAddres->getSavedAddress();

$customerSession = $_objectManager->create('Magento\Customer\Model\Session');
$getIdcus = $customerSession->getCustomerId();


$countryList = $savedAddres->getCountries();
$regionList = $savedAddres->getRegion();

// get customer default 
$addressInfo = $_objectManager->get('BinaryAnvil\Customer\Block\Addressinfo');
$shippingAddress = $addressInfo->getDefaultShippingAddress();
if(isset($shippingAddress)){
    $changeArray = array();
    $changeArray = $shippingAddress->__toArray();
    // echo "<pre>";print_r($changeArray);
    $street = $changeArray['street'][0];
    $getregion_id = $changeArray['region_id'];
    $customer_id = $changeArray['customer_id'];
    $firstname = $changeArray['firstname'];
    $lastname = $changeArray['lastname'];
}


?>

<div class="save-address">
    <div class="title-address">
        <span>Save addresses</span>
        <a href="javascript:void(0)" class="link-edit-address"><?= __('Edit'); ?></a>
    </div>
    <div class="box-address">
        <div class="content-address">
            <p>
                <?php if ($getAddres): ?>
                    <?= $getAddres ?>
                <?php else: ?>
                    <span>None</span>
                <?php endif; ?>
            </p>
        </div>
        <?php if ($getAddres): ?>
        <div class="content-edit-address">
            <div class="box-edit-address">
                <div class="content-details">
                    <div class="field field-firstname required">
                        <label class="label" for="name">
                            <span><?php echo __('name') ?></span>
                        </label>
                        <div class="control">
                            <input type="text" id="name" name="firstname" value="<?= $firstname; ?>" title="Name"
                                   class="input-text required-entry" data-validate="{required:true}"
                                   aria-required="true">
                        </div>
                    </div>
                </div>
                <div class="content-details">
                    <div class="field field-lastname required">
                        <label class="label" for="lastname">
                            <span><?php echo __('last name') ?></span>
                        </label>
                        <div class="control">
                            <input type="text" id="lastname" name="lastname" value="<?= $lastname; ?>" title="Last Name"
                                   class="input-text required-entry" data-validate="{required:true}"
                                   aria-required="true">
                        </div>
                    </div>
                </div>
                <div class="content-details">
                    <div class="field field-address required">
                        <label class="label" for="address">
                            <span><?php echo __('address') ?></span>
                        </label>
                        <div class="control">
                            <input type="text" id="address" name="address" value="<?= $street; ?>" title="Address"
                                   class="input-text required-entry" data-validate="{required:true}"
                                   aria-required="true">
                        </div>
                    </div>
                </div>
                <div class="content-details">
                    <div class="field field-city required">
                        <label class="label" for="city">
                            <span><?php echo __('city') ?></span>
                        </label>
                        <div class="control">
                            <input type="text" id="city" name="city" value="<?= $shippingAddress->getCity(); ?>"
                                   title="City" class="input-text required-entry" data-validate="{required:true}"
                                   aria-required="true">
                        </div>
                    </div>
                </div>
                <div class="content-details">
                    <div class="field state">
                        <label class="label" for="state">
                            <span><?php echo __('state') ?></span>
                        </label>
                        <div class="control">
                            <?php echo $regionList; ?>
                        </div>
                    </div>
                </div>
                <div class="content-details zip-code">
                    <div class="field field-zip-code required">
                        <label class="label" for="zipcode">
                            <span><?php echo __('zip code') ?></span>
                        </label>
                        <div class="control">
                            <input type="text" id="zipcode" name="zipcode"
                                   value="<?= $shippingAddress->getPostCode(); ?>" title="zipcode"
                                   class="input-text required-entry" data-validate="{required:true}"
                                   aria-required="true">
                        </div>
                    </div>
                </div>
                <div class="content-details phone">
                    <div class="field field-phone required">
                        <label class="label" for="phone">
                            <span><?php echo __('phone') ?></span>
                        </label>
                        <div class="control">
                            <input type="text" id="phone" name="phone" value="<?= $shippingAddress->getTelephone(); ?>"
                                   title="phone" class="input-text required-entry" data-validate="{required:true}"
                                   aria-required="true">
                        </div>
                    </div>
                </div>
                <div class="content-details country">
                    <div class="field country">
                        <label class="label" for="country">
                            <span><?php echo __('country') ?></span>
                        </label>
                        <div class="control">
                            <?php echo $countryList; ?>
                        </div>
                    </div>
                </div>
                <div class="primary">
                    <button type="submit" class="action save primary" title="<?= /* @escapeNotVerified */
                    __('Save') ?>"><span><?= /* @escapeNotVerified */
                            __('Save Changes') ?></span></button>
                </div>
            </div>
        </div>
        <?php endif; ?>
    </div>
</div>
<?php
$resource = $_objectManager->get('Magento\Framework\App\ResourceConnection');
$connection = $resource->getConnection();
$tableName = $resource->getTableName('local_retailer_store');

$sql = "Select * FROM " . $tableName. " WHERE id_customer_use =". $getIdcus;
$array_customer = $connection->fetchAll($sql);
if (!empty($array_customer)){
    foreach ($array_customer as $key) {
        $retailerId = $key['retailer_id'];
        break;
    } ?>
<style type="text/css">
    #<?= $retailerId; ?> .product-items .<?= $retailerId; ?> .make-this-store span {
        display: none;
    }
    #<?= $retailerId; ?> .product-items .<?= $retailerId; ?> .location-radio .label{
        display: block !important;
    }
</style>
<?php }
?>
<div class="my-local-retailer" id="retailer-store">
    <div class="box-local-retailer">
        <div class="header-retailer">
            <span class="title"><?= /* @escapeNotVerified */
                __('My local retailer') ?></span>
            <p class="text-retails">We partner together with local infinity retailers to bring you this infinity site.
                Please share below who is doing a great job in your community so we can recognize them. We hope you
                visit your favorite infinity scrubs store soon!</p>
        </div>
        <div class="content-retailer">
            <span class="find">Find nearest store</span>
            <div class="content-details zip">
                <div class="field field-zip required">
                    <label class="label" for="zipcode">
                        <span><?php echo __('zip code') ?></span>
                    </label>
                    <div class="control">
                        <input type="text" id="zip" name="zip" value="" title="zip" placeholder="Zip or City, State"
                               class="input-text  input-zip" data-validate="{required:true}" aria-required="true">
                    </div>
                </div>
            </div>
            <span class="join-text"><?php echo __('within') ?></span>
            <div class="content-details distance">
                <div class="control select-control">
                    <select id="storeSelector" class="select">
                        <option value="">Please select a radius.</option>
                        <option value="5" data-title="5 miles">5 miles</option>
                        <option value="10" data-title="10 miles">10 miles</option>
                        <option value="20" data-title="20 miles">20 miles</option>
                        <option value="30" data-title="30 miles">30 miles</option>
                        <option value="40" data-title="40 miles">40 miles</option>
                        <option value="50" data-title="50 miles">50 miles</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="footer-retailer" id="<?php if(isset($retailerId)){echo $retailerId;} ?>">
            <div class="products list items product-items the-bottom-slider">
            </div>
        </div>
    </div>
</div>
<script>
    require(['jquery'], function ($) {
        $(function () {
            $('.link-edit-address').click(function (e) {
                if ($(this).hasClass("focus")) {
                    $(this).removeClass('focus');
                    $(this).parent().parent().removeClass('active');
                } else {
                    $(this).addClass('focus');
                    $(this).parent().parent().addClass('active');
                }
            });
            <?php if ($getAddres): ?>
            // select state
            $('.content-details .state #state option[value="<?= $getregion_id ?>"]').attr('selected', 'selected');

            $(".action.save.primary").click(function (e) {

                var name = $('.box-edit-address #name').val();
                var lastname = $('.box-edit-address #lastname').val();
                var address = $('.box-edit-address #address').val();
                var city = $('.box-edit-address #city').val();
                var phone = $('.box-edit-address #phone').val();
                var zipcode = $('.box-edit-address #zipcode').val();
                var state = $(".box-edit-address #state").val();
                var country = $(".box-edit-address #country").val();
                var customer_id = <?= $customer_id ?>;

                jQuery.ajax({
                    url: '<?php echo $this->getBaseUrl() . 'content/load/load'?>',
                    type: "POST",
                    dataType: 'json',
                    showLoader: true,
                    data: {
                        name: name,
                        lastname: lastname,
                        address: address,
                        city: city,
                        phone: phone,
                        zipcode: zipcode,
                        state: state,
                        country: country,
                        customer_id: customer_id
                    },
                    success: function (data) {
                        location.reload();
                    }
                });
            });
            <?php endif; ?>
        });
    });
</script>
<script type="text/javascript">
    require([ 'jquery'], function($){     
        $(document.body).on('click', '.make-this-store span' ,function(e){
            $('.make-this-store').removeClass('active');
            $(this).parent().addClass('active');
            var monday = "no", saturday = "no";
            var retailerid = $('.make-this-store.active .retailerid-retailer').val();
            var storename = $('.make-this-store.active .storename-retailer').val();
            var street = $('.make-this-store.active .street-retailer').val();
            var city = $('.make-this-store.active .city-retailer').val();
            var state = $('.make-this-store.active .state-retailer').val();
            var zip = $('.make-this-store.active .zip-retailer').val();
            var distance = $('.make-this-store.active .distance-retailer').val();
            var phone = $('.make-this-store.active .phone-retailer').val();
                monday = $('.make-this-store.active .monday-retailer').val();
                saturday = $('.make-this-store.active .saturday-retailer').val();
            var getidcus = <?= $getIdcus ?>;
            jQuery.ajax({
                url: '<?php echo $this->getBaseUrl() . 'localretailer/load/load'?>',
                type: "POST",
                dataType: 'json',
                showLoader: true,
                data: {
                    retailerid: retailerid,
                    storename: storename,
                    street: street,
                    city: city,
                    state: state,
                    zip: zip,
                    distance: distance,
                    phone: phone,
                    monday: monday,
                    saturday: saturday,
                    getidcus: getidcus
                },
                success: function (data) {
                    // location.reload();
                    $('.footer-retailer').removeAttr('id');
                    $('.footer-retailer').attr( 'id', retailerid );
                    $(".customer-account-edit .column.main .my-local-retailer .box-local-retailer .footer-retailer .location .location-radio .label").removeAttr( 'style' );
                    $(".customer-account-edit .column.main .my-local-retailer .box-local-retailer .footer-retailer .location."+retailerid+" .location-radio .label").css("display", "block");

                    $(".make-this-store span").removeAttr( 'style' );
                    $(".make-this-store.active span").css("display", "none");
                }
            });
        }); 
    });
</script>